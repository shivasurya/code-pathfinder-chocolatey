name: Build Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.1.0) - leave empty to use version from nuspec'
        required: false
        type: string
  push:
    branches: [main]
    paths:
      - 'code-pathfinder.nuspec'
      - 'tools/**'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Chocolatey
        shell: pwsh
        run: |
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host "Installing Chocolatey..."
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          } else {
            Write-Host "Chocolatey already installed"
          }
          choco --version

      - name: Get version from nuspec
        id: version
        shell: pwsh
        run: |
          $nuspecContent = Get-Content 'code-pathfinder.nuspec' -Raw
          if ($nuspecContent -match '<version>([^<]+)</version>') {
            $version = $matches[1]
            echo "version=$version" >> $env:GITHUB_OUTPUT
            Write-Host "Package version: $version"
          } else {
            throw "Could not extract version from nuspec"
          }

      - name: Build Chocolatey package
        shell: pwsh
        run: |
          Write-Host "Building package..."
          choco pack

          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          if (-not $nupkg) {
            throw "Package build failed - no .nupkg file found"
          }

          Write-Host "Built package: $($nupkg.Name)"
          Write-Host "Package size: $([math]::Round($nupkg.Length / 1MB, 2)) MB"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: chocolatey-package-${{ steps.version.outputs.version }}
          path: "*.nupkg"
          retention-days: 90

      - name: Push to Chocolatey.org
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if (-not $env:CHOCO_API_KEY) {
            Write-Host "âš ï¸  CHOCO_API_KEY not set in secrets. Skipping push to Chocolatey.org" -ForegroundColor Yellow
            Write-Host "To enable automatic publishing:" -ForegroundColor Yellow
            Write-Host "1. Get API key from https://community.chocolatey.org/account" -ForegroundColor Yellow
            Write-Host "2. Add it to GitHub Secrets as CHOCO_API_KEY" -ForegroundColor Yellow
            Write-Host "3. Re-run this workflow" -ForegroundColor Yellow
            exit 0
          }

          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          Write-Host "Pushing $($nupkg.Name) to Chocolatey.org..." -ForegroundColor Cyan

          choco push $nupkg.FullName --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY

          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Package successfully pushed to Chocolatey.org!" -ForegroundColor Green
            Write-Host "Track moderation status at: https://community.chocolatey.org/packages/code-pathfinder/" -ForegroundColor Cyan
          } else {
            Write-Host "âŒ Failed to push package to Chocolatey.org" -ForegroundColor Red
            exit 1
          }

      - name: Create package summary
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          $version = '${{ steps.version.outputs.version }}'
          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          $apiKeySet = -not [string]::IsNullOrEmpty($env:CHOCO_API_KEY)

          if ($apiKeySet) {
            $statusSection = @"
          ## ðŸš€ Automated Submission

          The package has been automatically pushed to Chocolatey.org!

          - ðŸ“¦ Package: $($nupkg.Name)
          - ðŸ”— Track status: https://community.chocolatey.org/packages/code-pathfinder/
          - â±ï¸  Moderation time: 1-7 days for first submission
          - ðŸ“§ You'll receive an email when approved or if changes are requested

          ### What Happens Next

          1. **Moderation Review**: Chocolatey moderators will review your package
          2. **Approval**: Once approved, package will be live on Chocolatey.org
          3. **Install**: Users can install with: \`choco install code-pathfinder\`
          "@
          } else {
            $statusSection = @"
          ## âš ï¸ Manual Submission Required

          **CHOCO_API_KEY is not set** - Package was built but not pushed automatically.

          ### To Enable Automatic Publishing:

          1. Get your API key from: https://community.chocolatey.org/account
          2. Add it to GitHub Secrets as \`CHOCO_API_KEY\`
          3. Re-run this workflow or push changes to trigger automatic publishing

          ### Manual Push Instructions:

          From a Windows machine with Chocolatey installed:

          \`\`\`powershell
          choco push $($nupkg.Name) --source https://push.chocolatey.org/ --api-key YOUR_API_KEY
          \`\`\`
          "@
          }

          @"
          # Chocolatey Package Built Successfully

          ## Package Details
          - **Package**: code-pathfinder
          - **Version**: $version
          - **Filename**: $($nupkg.Name)
          - **Size**: $([math]::Round($nupkg.Length / 1MB, 2)) MB

          $statusSection

          ## ðŸ“¦ Package Contents

          - Binary: pathfinder-windows-amd64.exe (v$version)
          - Python DSL: codepathfinder v$version
          - Install script: chocolateyinstall.ps1
          - Uninstall script: chocolateyuninstall.ps1
          - Verification: VERIFICATION.txt

          ## ðŸ“¥ Artifact Download

          The .nupkg file is available as an artifact (90-day retention):
          - Artifact name: \`chocolatey-package-$version\`
          - Available in the "Summary" tab below

          ---
          ðŸ“š **Documentation**: https://docs.chocolatey.org/en-us/create/commands/push
          "@ >> $env:GITHUB_STEP_SUMMARY
