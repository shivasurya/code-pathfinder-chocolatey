name: Build Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.1.0) - leave empty to use version from nuspec'
        required: false
        type: string
  push:
    branches: [main]
    paths:
      - 'code-pathfinder.nuspec'
      - 'tools/**'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Chocolatey
        shell: pwsh
        run: |
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host "Installing Chocolatey..."
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          } else {
            Write-Host "Chocolatey already installed"
          }
          choco --version

      - name: Get version from nuspec
        id: version
        shell: pwsh
        run: |
          $nuspecContent = Get-Content 'code-pathfinder.nuspec' -Raw
          if ($nuspecContent -match '<version>([^<]+)</version>') {
            $version = $matches[1]
            echo "version=$version" >> $env:GITHUB_OUTPUT
            Write-Host "Package version: $version"
          } else {
            throw "Could not extract version from nuspec"
          }

      - name: Build Chocolatey package
        shell: pwsh
        run: |
          Write-Host "Building package..."
          choco pack

          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          if (-not $nupkg) {
            throw "Package build failed - no .nupkg file found"
          }

          Write-Host "Built package: $($nupkg.Name)"
          Write-Host "Package size: $([math]::Round($nupkg.Length / 1MB, 2)) MB"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: chocolatey-package-${{ steps.version.outputs.version }}
          path: "*.nupkg"
          retention-days: 90

      - name: Create package summary
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.version }}'
          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1

          @"
          # Chocolatey Package Built Successfully

          ## Package Details
          - **Package**: code-pathfinder
          - **Version**: $version
          - **Filename**: $($nupkg.Name)
          - **Size**: $([math]::Round($nupkg.Length / 1MB, 2)) MB

          ## Submission to Chocolatey.org

          âš ï¸ **Important**: Chocolatey.org no longer accepts direct .nupkg uploads via web UI. All packages must be pushed using the \`choco push\` command.

          ### Step 1: Download the Package

          1. Go to the **"Summary"** tab of this workflow run (scroll down)
          2. Download the artifact: \`chocolatey-package-$version\`
          3. Extract the .nupkg file

          ### Step 2: Get Your API Key

          1. Visit: https://community.chocolatey.org/account
          2. Copy your API key
          3. On your Windows machine, run:
             \`\`\`powershell
             choco apikey --key YOUR_API_KEY --source https://push.chocolatey.org/
             \`\`\`

          ### Step 3: Push the Package

          From a **Windows machine** with Chocolatey installed:

          \`\`\`powershell
          choco push $($nupkg.Name) --source https://push.chocolatey.org/
          \`\`\`

          Or with explicit API key:

          \`\`\`powershell
          choco push $($nupkg.Name) --source https://push.chocolatey.org/ --api-key YOUR_API_KEY
          \`\`\`

          ### Step 4: Wait for Moderation

          - First submission: 1-7 days for moderation review
          - Track status at: https://community.chocolatey.org/packages/code-pathfinder/
          - You'll receive an email when approved or if changes are requested

          ## Package Contents

          - Binary: pathfinder-windows-amd64.exe (v$version)
          - Python DSL: codepathfinder v$version
          - Install script: chocolateyinstall.ps1
          - Uninstall script: chocolateyuninstall.ps1
          - Verification: VERIFICATION.txt

          ## Future Automation

          After becoming a **trusted maintainer** (3-5 approved packages), you can automate pushes by:
          1. Adding \`CHOCO_API_KEY\` to GitHub Secrets
          2. The workflow can auto-push on new releases

          ---
          ðŸ“š **Documentation**: https://docs.chocolatey.org/en-us/create/commands/push
          "@ >> $env:GITHUB_STEP_SUMMARY
