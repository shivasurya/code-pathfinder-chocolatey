name: Update Package

on:
  repository_dispatch:
    types: [new-release]

  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., 1.1.0) - WITHOUT v prefix'
        required: true
        type: string

jobs:
  update-package:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version (strip v prefix if present)
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_EVENT_NAME -eq 'repository_dispatch') {
            $rawVersion = '${{ github.event.client_payload.version }}'
            $version = $rawVersion -replace '^v', ''
          } else {
            $version = '${{ github.event.inputs.version }}'
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Processing version: $version"

      - name: Wait for release assets
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.version }}'
          $url = "https://github.com/shivasurya/code-pathfinder/releases/download/v$version/pathfinder-windows-amd64.exe"

          Write-Host "Waiting for release assets to be available..."
          for ($i = 1; $i -le 30; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $url -Method Head -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                Write-Host "Assets available!"
                break
              }
            } catch {
              Write-Host "Attempt $i`: Assets not ready, waiting 10s..."
              Start-Sleep -Seconds 10
            }
          }

      - name: Get python-dsl version and PyPI SHA256
        id: python_dsl
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.version }}'
          Write-Host "Cloning code-pathfinder repo at tag v$version..."

          # Clone the specific version tag
          git clone --depth 1 --branch "v$version" https://github.com/shivasurya/code-pathfinder.git code-pathfinder-repo

          # Extract version from pyproject.toml
          $pyprojectPath = "code-pathfinder-repo\python-dsl\pyproject.toml"
          if (-not (Test-Path $pyprojectPath)) {
            throw "ERROR: python-dsl/pyproject.toml not found in repo"
          }

          $content = Get-Content $pyprojectPath -Raw
          if ($content -match 'version\s*=\s*"([^"]+)"') {
            $pythonDslVersion = $matches[1]
            echo "version=$pythonDslVersion" >> $env:GITHUB_OUTPUT
            Write-Host "Found python-dsl version: $pythonDslVersion"
          } else {
            throw "ERROR: Could not extract version from pyproject.toml"
          }

          # Get PyPI package SHA256
          Write-Host "Fetching PyPI package checksum..."
          $pypiJson = Invoke-RestMethod "https://pypi.org/pypi/codepathfinder/$pythonDslVersion/json"
          $wheelInfo = $pypiJson.urls | Where-Object { $_.packagetype -eq "bdist_wheel" }

          if (-not $wheelInfo) {
            throw "ERROR: Could not find wheel package on PyPI for version $pythonDslVersion"
          }

          $pypiSha256 = $wheelInfo.digests.sha256.ToLower()
          echo "pypi_sha256=$pypiSha256" >> $env:GITHUB_OUTPUT
          Write-Host "PyPI SHA256: $pypiSha256"

          # Cleanup
          Remove-Item -Path code-pathfinder-repo -Recurse -Force

      - name: Download and calculate SHA256
        id: sha256
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.version }}'
          $url = "https://github.com/shivasurya/code-pathfinder/releases/download/v$version/pathfinder-windows-amd64.exe"
          $exeFile = "pathfinder-windows-amd64.exe"

          Write-Host "Downloading $exeFile..."
          Invoke-WebRequest -Uri $url -OutFile $exeFile

          if (-not (Test-Path $exeFile) -or (Get-Item $exeFile).Length -eq 0) {
            throw "Failed to download $exeFile"
          }

          $hash = (Get-FileHash -Path $exeFile -Algorithm SHA256).Hash.ToLower()
          echo "sha256=$hash" >> $env:GITHUB_OUTPUT
          Write-Host "SHA256: $hash"

      - name: Update package files
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.version }}'
          $pythonDslVersion = '${{ steps.python_dsl.outputs.version }}'
          $sha256 = '${{ steps.sha256.outputs.sha256 }}'
          $pypiSha256 = '${{ steps.python_dsl.outputs.pypi_sha256 }}'
          $url = "https://github.com/shivasurya/code-pathfinder/releases/download/v$version/pathfinder-windows-amd64.exe"

          Write-Host "Updating package files..."
          Write-Host "Binary version: $version"
          Write-Host "Python DSL version: $pythonDslVersion"
          Write-Host "PyPI SHA256: $pypiSha256"

          # Update nuspec
          $nuspec = Get-Content -Path 'code-pathfinder.nuspec' -Raw
          $nuspec = $nuspec -replace '<version>[^<]+</version>', "<version>$version</version>"
          Set-Content -Path 'code-pathfinder.nuspec' -Value $nuspec -NoNewline

          # Update chocolateyinstall.ps1
          $install = Get-Content -Path 'tools/chocolateyinstall.ps1' -Raw
          $install = $install -replace "\`$version = '[^']+'\s*# VERSION_MARKER", "`$version = '$version'  # VERSION_MARKER"
          $install = $install -replace "\`$pythonDslVersion = '[^']+'\s*# PYTHON_DSL_VERSION_MARKER", "`$pythonDslVersion = '$pythonDslVersion'  # PYTHON_DSL_VERSION_MARKER"
          $install = $install -replace "\`$url = '[^']+'\s*# URL_MARKER", "`$url = '$url'  # URL_MARKER"
          $install = $install -replace "\`$checksum = '[^']+'\s*# SHA256_MARKER", "`$checksum = '$sha256'  # SHA256_MARKER"
          $install = $install -replace "\`$pypiChecksum = '[^']+'\s*# PYPI_SHA256_MARKER", "`$pypiChecksum = '$pypiSha256'  # PYPI_SHA256_MARKER"
          Set-Content -Path 'tools/chocolateyinstall.ps1' -Value $install -NoNewline

          # Update VERIFICATION.txt
          $verification = Get-Content -Path 'tools/VERIFICATION.txt' -Raw
          $verification = $verification -replace 'Version: [^\r\n]+', "Version: $version (Python DSL: $pythonDslVersion)"
          $verification = $verification -replace 'releases/tag/v[^\r\n]+', "releases/tag/v$version"
          $verification = $verification -replace 'releases/download/v[^/]+/pathfinder-windows-amd64\.exe', "releases/download/v$version/pathfinder-windows-amd64.exe"
          $verification = $verification -replace 'SHA256 Checksum:\s*[^\r\n]+', "SHA256 Checksum:`n$sha256"
          $verification = $verification -replace 'codepathfinder/[0-9.]+/', "codepathfinder/$pythonDslVersion/"
          $verification = $verification -replace 'PyPI SHA256 Checksum:\s*[^\r\n]+', "PyPI SHA256 Checksum:`n$pypiSha256"
          Set-Content -Path 'tools/VERIFICATION.txt' -Value $verification -NoNewline

          Write-Host "All files updated"

      - name: Install Chocolatey
        shell: pwsh
        run: |
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host "Installing Chocolatey..."
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }

      - name: Validate and build package
        shell: pwsh
        run: |
          Write-Host "Building package..."
          choco pack

          if (-not (Test-Path "code-pathfinder.${{ steps.version.outputs.version }}.nupkg")) {
            throw "Package build failed"
          }

          Write-Host "Package built successfully"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update code-pathfinder to ${{ steps.version.outputs.version }}"
          title: "Update code-pathfinder to ${{ steps.version.outputs.version }}"
          body: |
            Automated package update for code-pathfinder ${{ steps.version.outputs.version }}

            ## Release
            - Version: `${{ steps.version.outputs.version }}`
            - Python DSL: `${{ steps.python_dsl.outputs.version }}`
            - Release URL: https://github.com/shivasurya/code-pathfinder/releases/tag/v${{ steps.version.outputs.version }}

            ## Changes
            - Updated `code-pathfinder.nuspec` version
            - Updated `tools/chocolateyinstall.ps1` URL and checksums
            - Updated `tools/VERIFICATION.txt` with new version info

            ## Installation
            ```powershell
            choco install code-pathfinder --version=${{ steps.version.outputs.version }}
            ```

            ## SHA256 Checksums
            **Binary:**
            ```
            ${{ steps.sha256.outputs.sha256 }}
            ```

            **PyPI Package:**
            ```
            ${{ steps.python_dsl.outputs.pypi_sha256 }}
            ```

            ## Verification
            To verify the download:
            ```powershell
            Invoke-WebRequest -Uri "https://github.com/shivasurya/code-pathfinder/releases/download/v${{ steps.version.outputs.version }}/pathfinder-windows-amd64.exe" -OutFile pathfinder.exe
            Get-FileHash pathfinder.exe -Algorithm SHA256
            ```

            ---
            Automated by [update-package.yml](https://github.com/shivasurya/code-pathfinder-chocolatey/blob/main/.github/workflows/update-package.yml)
          branch: update-${{ steps.version.outputs.version }}
          delete-branch: true
